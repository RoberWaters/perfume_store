{% extends 'shop/admin/base_admin.html' %}

{% block title %}Orden {{ order.order_number }}{% endblock %}
{% block page_title %}Detalle de Orden - {{ order.order_number }}{% endblock %}

{% block content %}
<div class="admin-order-detail-grid">
    <!-- Informaci√≥n de la Orden -->
    <div class="admin-panel-card">
        <h3>Informaci√≥n General</h3>
        <div class="order-info-grid">
            <div class="info-item">
                <strong>N√∫mero de Orden:</strong>
                <span>{{ order.order_number }}</span>
            </div>
            <div class="info-item">
                <strong>Estado:</strong>
                <span class="badge badge-{{ order.status|lower }}">{{ order.status }}</span>
            </div>
            <div class="info-item">
                <strong>Fecha de Creaci√≥n:</strong>
                <span>{{ order.created_at|date:"d/m/Y H:i" }}</span>
            </div>
            <div class="info-item">
                <strong>Total:</strong>
                <span class="price-highlight">L. {{ order.total_amount }}</span>
            </div>
        </div>
    </div>

    <!-- Informaci√≥n del Cliente -->
    <div class="admin-panel-card">
        <h3>Informaci√≥n del Cliente</h3>
        <div class="order-info-grid">
            <div class="info-item">
                <strong>Nombre:</strong>
                <span>{{ order.user.username }}</span>
            </div>
            <div class="info-item">
                <strong>Email:</strong>
                <span>{{ order.user.email }}</span>
            </div>
            <div class="info-item">
                <strong>Direcci√≥n:</strong>
                <span>{{ order.shipping_address }}</span>
            </div>
            <div class="info-item">
                <strong>Ciudad:</strong>
                <span>{{ order.shipping_city }}, {{ order.shipping_state }}</span>
            </div>
            <div class="info-item">
                <strong>C√≥digo Postal:</strong>
                <span>{{ order.shipping_postal_code }}</span>
            </div>
            {% if order.notes %}
            <div class="info-item full-width">
                <strong>Notas:</strong>
                <span>{{ order.notes }}</span>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Productos -->
<div class="admin-panel-card">
    <h3>Productos de la Orden</h3>
    <div class="table-responsive">
        <table class="admin-table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Precio Unitario</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in order.items.all %}
                <tr>
                    <td><strong>{{ item.perfume.name }}</strong></td>
                    <td>L. {{ item.price }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>L. {{ item.subtotal }}</td>
                </tr>
                {% endfor %}
                <tr class="total-row">
                    <td colspan="3" class="text-right"><strong>Total:</strong></td>
                    <td><strong>L. {{ order.total_amount }}</strong></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Cambiar Estado -->
<div class="admin-panel-card">
    <h3>Actualizar Estado de la Orden</h3>
    {% if order.status == 'Cancelado' %}
    <div style="padding: 1.5rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; margin-bottom: 1.5rem;">
        <p style="margin: 0; color: #856404; font-weight: 500;">
            ‚ö†Ô∏è Esta orden ha sido cancelada y no se puede cambiar su estado.
        </p>
    </div>
    {% endif %}
    <form method="POST" class="status-update-form" id="statusForm" onsubmit="return confirmCancellation(event)">
        {% csrf_token %}
        <div class="form-row">
            <div class="form-group col-8">
                <label>Nuevo Estado:</label>
                <select name="status" id="statusSelect" class="form-control" {% if order.status == 'Cancelado' %}disabled{% endif %}>
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if value == order.status %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-4">
                <label>&nbsp;</label>
                <button type="submit" class="btn btn-accent full-width" {% if order.status == 'Cancelado' %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                    üîÑ Actualizar Estado
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function confirmCancellation(event) {
    const statusSelect = document.getElementById('statusSelect');
    const selectedStatus = statusSelect.value;
    const currentStatus = '{{ order.status }}';

    // Si se est√° cambiando a "Cancelado", pedir confirmaci√≥n
    if (selectedStatus === 'Cancelado' && currentStatus !== 'Cancelado') {
        const confirmed = confirm(
            '‚ö†Ô∏è ¬øEst√°s seguro de que deseas cancelar esta orden?\n\n' +
            'Esta acci√≥n:\n' +
            '‚Ä¢ Restaurar√° el stock de todos los perfumes\n' +
            '‚Ä¢ No se podr√° revertir\n' +
            '‚Ä¢ El estado no podr√° cambiarse despu√©s\n\n' +
            '¬øDeseas continuar?'
        );

        if (!confirmed) {
            event.preventDefault();
            return false;
        }
    }

    return true;
}
</script>

<!-- Historial de Estados -->
{% if order.status_history.all %}
<div class="admin-panel-card">
    <h3>Historial de Estados</h3>
    <div class="status-history">
        {% for history in order.status_history.all %}
        <div class="history-item">
            <div class="history-icon">üìù</div>
            <div class="history-content">
                <p><strong>{{ history.new_status }}</strong></p>
                <p class="history-meta">
                    {{ history.created_at|date:"d/m/Y H:i" }}
                    {% if history.changed_by %} por {{ history.changed_by.username }}{% endif %}
                </p>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="form-actions">
    <a href="{% url 'shop:admin_orders_list' %}" class="btn btn-secondary">‚¨ÖÔ∏è Volver al Listado</a>
</div>
{% endblock %}
